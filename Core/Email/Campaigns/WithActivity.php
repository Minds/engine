<?php


namespace Minds\Core\Email\Campaigns;


use Minds\Core\Config;
use Minds\Core\Email\Mailer;
use Minds\Core\Email\Message;
use Minds\Core\Email\Template;
use Minds\Entities\Activity;
use Minds\Entities\User;

class WithActivity extends EmailCampaign
{
    protected $template;
    protected $mailer;

    protected $posts;

    public function __construct(Template $template = null, Mailer $mailer = null)
    {
        $this->template = $template ?: new Template();
        $this->mailer = $mailer ?: new Mailer();
        $this->campaign = 'with';
        $this->topic = 'top_posts';
    }

    /**
     * @param Activity[] $posts
     * @return $this
     */
    public function setPosts($posts)
    {
        $this->posts = $posts;
        return $this;
    }

    public function send()
    {
        $this->template->setTemplate('default.tpl');

        $this->template->setBody("./Templates/top-posts.tpl");

        $validatorHash = sha1($this->campaign . $this->user->guid . Config::_()->get('emails_secret'));

        $this->template->set('user', $this->user);
        $this->template->set('username', $this->user->username);
        $this->template->set('email', $this->user->getEmail());

        $this->posts[] = new Activity('823497917649129483');
        $this->posts[] = new Activity([
            "guid" => "823977248501788672",
            "type" => "activity",
            "time_created" => 1521827484,
            "time_updated" => 1521827484,
            "container_guid" => "100000000000000134",
            "owner_guid" => "100000000000000134",
            "access_id" => 2,
            "blurb" => false,
            "perma_url" => false,
            "message" => "#minds #thegreatmigration #deletefacebook",
            "ownerObj" => new User([
                "guid" => "100000000000000134",
                "type" => "user",
                "subtype" => false,
                "time_created" => "1348444800",
                "time_updated" => "1380486497",
                "container_guid" => "0",
                "owner_guid" => "100000000000000000",
                "site_guid" => "1",
                "access_id" => "2",
                "name" => "John",
                "username" => "john",
                "language" => "en",
                "icontime" => "1453240966",
                "legacy_guid" => "134",
                "featured_id" => "757614539326890004",
                "banned" => "no",
                "website" => "",
                "briefdescription" => "John Ottman\nCo-founder\nMinds, Inc.\n",
                "dob" => "",
                "gender" => "male",
                "city" => "NYC",
                "merchant" => ["service" => "stripe", "id" => "acct_19R8YZGl5dWj4y06"],
                "boostProPlus" => false,
                "fb" => false,
                "mature" => 1,
                "monetized" => "",
                "signup_method" => false,
                "social_profiles" => [
                    ["key" => "minds", "value" => "https://www.minds.com/john"],
                    ["key" => "twitter", "value" => "https://twitter.com/johnottman"],
                    ["key" => "linkedin", "value" => "https://www.linkedin.com/in/john-ottman-091b173/"]
                ],
                "feature_flags" => false,
                "programs" => ["affiliate", "ads"],
                "plus" => true,
                "verified" => true,
                "founder" => false,
                "disabled_boost" => false,
                "categories" => ["news", "nature", "technology"],
                "wire_rewards" => [
                    "description" => "",
                    "rewards" => [
                        "points" => [
                            ["amount" => 200000, "description" => "One Google Hangout"],
                            ["amount" => 500000, "description" => "Three  Google Hangouts"],
                            ["amount" => 1000000, "description" => "Dinner in NYC"]
                        ],
                        "money" => []
                    ]
                ],
                "pinned_posts" => [],
                "chat" => true,
                "subscribed" => true,
                "subscriber" => true,
                "boost_rating" => "1",
                "spam" => 0,
                "deleted" => 0
            ]),
            "containerObj" => false,
            "thumbnail_src" => false,
            "remind_object" => new Activity([
                "guid" => "823971148527222784",
                "type" => "activity",
                "time_created" => "1521826030",
                "time_updated" => "1521826030",
                "container_guid" => "393214855760318464",
                "owner_guid" => "393214855760318464",
                "access_id" => "2",
                "title" => "Breaking: Elon Musk Deletes SpaceX, Tesla Facebook Pages",
                "blurb" => "We suspect Zuckerberg will be slow to respond... he's too busy preparing for his congressional testimony.",
                "perma_url" => "http://theantimedia.org/elon-musk-deletes-spacex-tesla-facebook-pages/",
                "message" => "We suspect Zuckerberg will be slow to respond... he's too busy preparing for his congressional testimony. ",
                "ownerObj" => new User([
                    "guid" => "393214855760318464",
                    "type" => "user",
                    "subtype" => false,
                    "time_created" => "1419125727",
                    "time_updated" => false,
                    "container_guid" => "0",
                    "owner_guid" => "0",
                    "site_guid" => false,
                    "access_id" => "2",
                    "name" => "The Anti-Media",
                    "username" => "theantimedia",
                    "language" => "en",
                    "icontime" => "1502388343",
                    "legacy_guid" => false,
                    "featured_id" => "639237247417196557",
                    "banned" => "no",
                    "website" => "",
                    "briefdescription" => "This is the official fan page for TheAntiMedia.org\n\nhttp://theantimedia.org/",
                    "dob" => "",
                    "gender" => "",
                    "city" => "",
                    "merchant" => [
                        "service" => "stripe",
                        "id" => "acct_1B6MznIPQDkQLR0D",
                        "exclusive" => ["enabled" => true, "amount" => "10"]
                    ],
                    "boostProPlus" => false,
                    "fb" => false,
                    "mature" => "0",
                    "monetized" => "",
                    "signup_method" => false,
                    "social_profiles" => [],
                    "feature_flags" => false,
                    "programs" => ["affiliate"],
                    "plus" => false,
                    "verified" => true,
                    "founder" => false,
                    "disabled_boost" => false,
                    "categories" => [],
                    "wire_rewards" => null,
                    "pinned_posts" => [],
                    "subscribed" => false,
                    "subscriber" => false,
                    "boost_rating" => "2"
                ]),
                "containerObj" => false,
                "thumbnail_src" => "http://theantimedia.org/wp-content/uploads/2018/03/elon-musk-facebook.jpg",
                "remind_object" => false,
                "entity_guid" => false,
                "featured" => false,
                "featured_guid" => false,
                "custom_type" => false,
                "custom_data" => false,
                "thumbs=>up=>count" => 7,
                "thumbs=>up=>user_guids" => [
                    "522136425798311955",
                    "100000000000001111",
                    "589295504215519249",
                    "741346709593923597",
                    "459199221849919488",
                    "700272970022526984",
                    "693857878443827217"
                ],
                "thumbs=>down=>count" => 0,
                "thumbs=>down=>user_guids" => false,
                "p2p_boosted" => false,
                "mature" => false,
                "monetized" => false,
                "paywall" => "",
                "edited" => "",
                "comments_enabled" => true,
                "wire_totals" => ["points" => "0", "money" => "0"],
                "boost_rejection_reason" => -1,
                "pending" => "",
                "comments=>count" => 0,
                "impressions" => 29,
                "reminds" => 0,
                "wire_threshold" => null
            ]),
            "entity_guid" => false,
            "featured" => false,
            "featured_guid" => false,
            "custom_type" => false,
            "custom_data" => false,
            "thumbs=>up=>count" => 162,
            "thumbs=>up=>user_guids" => [
                "785154871182499855",
                "100000000000001111",
                "785564328098013186",
                "681521414959800326",
                "678102378863403012",
                "796847861483446287",
                "822364918232653834",
                "656825276361089034",
                "774692225954095118",
                "739501858388713480",
                "625810447588663301",
                "629714948372574212",
                "675110887895343123",
                "458062802469261312",
                "740383228795297808",
                "618125168681689108",
                "624014086513893389",
                "100000000000000341",
                "626826296747368466",
                "793094048196861959",
                "618243780838957070",
                "784135836940640275",
                "625778010250813458",
                "540336113848426507",
                "458293021457256448",
                "460438113320177671",
                "587631788143157262",
                "823382175771533317",
                "782640809957662728",
                "699186432157163539",
                "800102283890139155",
                "817806532895842310",
                "819347179138195461",
                "818559723405058063",
                "824490695275323400",
                "823930917285273609",
                "811445844069851148",
                "824445708949004296",
                "798759690547765258",
                "802502277293154319",
                "748677781331648532",
                "798554903264894990",
                "820881166662901767",
                "808041602701336581",
                "816064221681819664",
                "817024181471289349",
                "823369835932033032",
                "824136761675358222",
                "796941654526271501",
                "539456061510262788",
                "816373065419071497",
                "769917783050821652",
                "771520265300484101",
                "824229962662813705",
                "821328523577794578",
                "459067068193447936",
                "824155983331729414",
                "824023500606939137",
                "711304045330964495",
                "824556423257006088",
                "812867685447639043",
                "647083447860338707",
                "823213485428056068",
                "813146242103123971",
                "822539491074908177",
                "813288213476024336",
                "700344692138582029",
                "811799600670187535",
                "684445621037309965",
                "824372988013977607",
                "818924171961573396",
                "739442661877882887",
                "813454370434719764",
                "792435827194994692",
                "781623702394511362",
                "824317940336697351",
                "812833612557721620",
                "824116310387466257",
                "808993200818626566",
                "466428432784306184",
                "817613779675127824",
                "797635481176121356",
                "784463876858060806",
                "815629481656983565",
                "786599065495281680",
                "822903298360090640",
                "815218668370665481",
                "824679621541765121",
                "820899445099995153",
                "824063247047991299",
                "786667525852110850",
                "715002352729333780",
                "709034738429468688"
            ],
            "thumbs=>down=>count" => 0,
            "thumbs=>down=>user_guids" => false,
            "p2p_boosted" => false,
            "monetized" => false,
            "edited" => 1,
            "comments_enabled" => true,
            "wire_totals" => ["tokens" => "0"],
            "boost_rejection_reason" => -1,
            "rating" => 1,
            "comments=>count" => 16,
            "impressions" => 5783,
            "reminds" => 20,
            "mature" => false,
            "wire_threshold" => null
        ]);
        $this->posts[] = new Activity([
            "guid" => "824010932030271488",
            "type" => "activity",
            "time_created" => 1521835515,
            "time_updated" => 1521835515,
            "container_guid" => "100000000000000134",
            "owner_guid" => "100000000000000134",
            "access_id" => 2,
            "title" => false,
            "blurb" => false,
            "perma_url" => false,
            "message" => "#deletefacebook #minds #thegreatmigration",
            "ownerObj" => new User([
                "guid" => "100000000000000134",
                "type" => "user",
                "subtype" => false,
                "time_created" => "1348444800",
                "time_updated" => "1380486497",
                "container_guid" => "0",
                "owner_guid" => "100000000000000000",
                "site_guid" => "1",
                "access_id" => "2",
                "name" => "John",
                "username" => "john",
                "language" => "en",
                "icontime" => "1453240966",
                "legacy_guid" => "134",
                "featured_id" => "757614539326890004",
                "banned" => "no",
                "website" => "",
                "briefdescription" => "John Ottman\nCo-founder\nMinds, Inc.\n",
                "dob" => "",
                "gender" => "male",
                "city" => "NYC",
                "merchant" => ["service" => "stripe", "id" => "acct_19R8YZGl5dWj4y06"],
                "boostProPlus" => false,
                "fb" => false,
                "mature" => 1,
                "monetized" => "",
                "signup_method" => false,
                "social_profiles" => [
                    ["key" => "minds", "value" => "https://www.minds.com/john"],
                    ["key" => "twitter", "value" => "https://twitter.com/johnottman"],
                    ["key" => "linkedin", "value" => "https://www.linkedin.com/in/john-ottman-091b173/"]
                ],
                "feature_flags" => false,
                "programs" => ["affiliate", "ads"],
                "plus" => true,
                "verified" => true,
                "founder" => false,
                "disabled_boost" => false,
                "categories" => ["news", "nature", "technology"],
                "wire_rewards" => [
                    "description" => "",
                    "rewards" => [
                        "points" => [
                            ["amount" => 200000, "description" => "One Google Hangout"],
                            ["amount" => 500000, "description" => "Three  Google Hangouts"],
                            ["amount" => 1000000, "description" => "Dinner in NYC"]
                        ],
                        "money" => []
                    ]
                ],
                "pinned_posts" => [],
                "chat" => true,
                "subscribed" => true,
                "subscriber" => true,
                "boost_rating" => "1",
                "spam" => 0,
                "deleted" => 0
            ]),
            "containerObj" => false,
            "thumbnail_src" => false,
            "remind_object" => new Activity([
                "guid" => "804322678140284928",
                "type" => "activity",
                "time_created" => "1517141470",
                "time_updated" => "1517141470",
                "container_guid" => "708987537296728073",
                "owner_guid" => "708987537296728073",
                "access_id" => "2",
                "title" => "",
                "blurb" => false,
                "perma_url" => false,
                "message" => "",
                "ownerObj" => new User([
                    "guid" => "708987537296728073",
                    "type" => "user",
                    "subtype" => false,
                    "time_created" => "1494411801",
                    "time_updated" => false,
                    "container_guid" => "0",
                    "owner_guid" => "0",
                    "site_guid" => false,
                    "access_id" => "2",
                    "name" => "Milica42 ",
                    "username" => "Milica42",
                    "language" => "en",
                    "icontime" => "1499679709",
                    "legacy_guid" => false,
                    "featured_id" => "775115674547658757",
                    "banned" => "no",
                    "website" => "",
                    "briefdescription" => "Inner peace",
                    "dob" => "",
                    "gender" => "",
                    "city" => "Zagreb",
                    "merchant" => false,
                    "boostProPlus" => "",
                    "fb" => [],
                    "mature" => "1",
                    "monetized" => "",
                    "signup_method" => false,
                    "social_profiles" => [],
                    "feature_flags" => false,
                    "programs" => [],
                    "plus" => false,
                    "verified" => false,
                    "disabled_boost" => false,
                    "categories" => [],
                    "wire_rewards" => ["description" => "", "rewards" => ["points" => [], "money" => []]],
                    "pinned_posts" => ["778928845070802948"],
                    "chat" => true,
                    "subscribed" => false,
                    "subscriber" => false,
                    "subscribers_count" => "6503",
                    "subscriptions_count" => "465",
                    "impressions" => "7828916",
                    "boost_rating" => "2"
                ]),
                "containerObj" => false,
                "thumbnail_src" => false,
                "remind_object" => false,
                "entity_guid" => "779002790117646338",
                "featured" => false,
                "featured_guid" => false,
                "custom_type" => "batch",
                "custom_data" => [
                    [
                        "src" => "https://www.minds.com/fs/v1/thumbnail/779002790117646338",
                        "href" => "https://www.minds.com/media/708987537296728073/779002790117646338",
                        "mature" => false,
                        "width" => "450",
                        "height" => "253"
                    ]
                ],
                "thumbs=>up=>count" => 2452,
                "thumbs=>up=>user_guids" => [
                    "752662355522887700",
                    "781271781494235141",
                    "618174019912343566",
                    "766583411153313803",
                    "698896142229839884",
                    "745272175493128198",
                    "694158459930681345",
                    "688852519090135059",
                    "694259449870688273",
                    "695022547648913422",
                    "619462027705851905",
                    "694261689561915411",
                    "742880291110002695",
                    "745212515566231568",
                    "625866404825931779",
                    "721524438016729106",
                    "699186432157163539",
                    "545905615344513031",
                    "467781061179351043",
                    "749730244201553923",
                    "804972109058023438",
                    "764159394987384840",
                    "783391970356633611",
                    "764872547933102100",
                    "799487557485207571",
                    "467099826589282315",
                    "767993675891351565",
                    "804908588098134022",
                    "100000000000000134",
                    "747174235264262155",
                    "794742375237820431",
                    "804146083277053956",
                    "804957847073857547",
                    "777681417051054081",
                    "498127197941276677",
                    "800102283890139155",
                    "802686275244007426",
                    "458977154466590720",
                    "770766993627291666",
                    "805134116952481795",
                    "785337030920904722",
                    "798050357279203345",
                    "771089924400095244",
                    "779281966548656142",
                    "804647318425968658",
                    "795900914899623950",
                    "465035144856612880",
                    "802936345033973764",
                    "798759690547765258",
                    "459097915009273856",
                    "746423182424023042",
                    "804409357591650313",
                    "464429758436876307",
                    "795696116019503116",
                    "458724606438551552",
                    "717674900457791491",
                    "805018140839780365",
                    "802282161959870476",
                    "576032114495987715",
                    "795948844922707978",
                    "803639928020803594",
                    "782270089519964174",
                    "798573924286734348",
                    "802345069561520134",
                    "803172916811276294",
                    "459149240573112320",
                    "483112467828846611",
                    "463644690965606417",
                    "805385365010522130",
                    "655353877922586637",
                    "804817935628509187",
                    "769551935538733068",
                    "791997424045400066",
                    "626383314583822346",
                    "783312688418660353",
                    "799000075438137359",
                    "804171933544357892",
                    "763450183525605390",
                    "768081354314227732",
                    "794781220280999951",
                    "780883552219701255",
                    "797483320505016339",
                    "703745808880640004",
                    "803135107907985418",
                    "783235158990921746",
                    "645722775339675650",
                    "720042625113006092",
                    "457200397958778880"
                ],
                "thumbs=>down=>count" => 10,
                "thumbs=>down=>user_guids" => ["804231832894709774"],
                "p2p_boosted" => false,
                "mature" => false,
                "monetized" => false,
                "paywall" => "",
                "edited" => "",
                "comments_enabled" => true,
                "wire_totals" => ["points" => "3000", "money" => "0"],
                "boost_rejection_reason" => -1,
                "pending" => "",
                "comments=>count" => 302,
                "impressions" => 9026,
                "reminds" => 82,
                "wire_threshold" => null,
                "spam" => false,
                "deleted" => false
            ]),
            "entity_guid" => false,
            "featured" => false,
            "featured_guid" => false,
            "custom_type" => false,
            "custom_data" => false,
            "thumbs=>up=>count" => 2674,
            "thumbs=>up=>user_guids" => [
                "813998087444897810",
                "684977429453742085",
                "695022547648913422",
                "703705390365286416",
                "519624964328923153",
                "782640809957662728",
                "813787420951584777",
                "459072646470963200",
                "662039704845164562",
                "772741801537708052",
                "626826296747368466",
                "618243780838957070",
                "823743190031933444",
                "741346709593923597",
                "498679026634727438",
                "683153198315216915",
                "748774975300706317",
                "458150867296587776",
                "625778010250813458",
                "618172067287670786",
                "664344180922785796",
                "540336113848426507",
                "819255108859600911",
                "822903298360090640",
                "813585552258375696",
                "587631788143157262",
                "740641533341999115",
                "683079330892357642",
                "813965995910635529",
                "822511974549037057",
                "824330314431078420",
                "824433806973870094",
                "458252779605987328",
                "760346996048404485",
                "732777006025941009",
                "815780109515497491",
                "816631460353024006",
                "820887775761932291",
                "545483403063996428",
                "823794249085493252",
                "624476036289011717",
                "822306561002053648",
                "823812663623557127",
                "815612054537773075",
                "824281117430390797",
                "816064221681819664",
                "823461513581830156",
                "820846591316336657",
                "768291226662215689",
                "824619583926181892",
                "758641657427009544",
                "468904979529211913",
                "824626982753935380",
                "758546245022130194",
                "100000000000047531",
                "823610972110331917",
                "821411990483247116",
                "764159394987384840",
                "824663537279311884",
                "759509851247222796",
                "824081912434794511",
                "823228712060198924",
                "817486378207027211",
                "789591060673208337",
                "813228336581976084",
                "821356616992432139",
                "824338506934394895",
                "517275188581117965",
                "823373224476680207",
                "823694183423287310",
                "760902529008541707",
                "824155983331729414",
                "769971213949739018",
                "816144507031527438",
                "823355672748892166",
                "824436952269856778",
                "824647013617377282",
                "800165065234849804",
                "824694876720341005",
                "824695507157786640",
                "822483685927297039",
                "820834026855079946",
                "778033284067106820",
                "784214960426196996",
                "818515812301152259",
                "812504576115613713",
                "823427528151539722",
                "783503035019042833",
                "652795700651761673",
                "797730660117651457",
                "824431776683270151",
                "824221162966884365",
                "817585911012270097",
                "824010914356273164",
                "820255476561223689",
                "813240174552031236",
                "824703668082188305",
                "818015345695531027",
                "824437459264741392",
                "781917895490805778",
                "814134739890872340",
                "824011583108685827",
                "822481815007666185",
                "824186011373281290",
                "823369835932033032",
                "802502277293154319",
                "684812140153937921",
                "784463876858060806",
                "541383671349784589",
                "806304869857107969",
                "815640528015073289",
                "618592091705974798",
                "823058310881091597",
                "625802017100537863",
                "771566957760618512",
                "815799803970592781",
                "816359286824247303",
                "823789005710565380",
                "801439408053035021",
                "715002352729333780",
                "699186432157163539",
                "709034738429468688"
            ],
            "thumbs=>down=>count" => 10,
            "thumbs=>down=>user_guids" => false,
            "p2p_boosted" => false,
            "monetized" => false,
            "comments_enabled" => true,
            "wire_totals" => ["tokens" => "0"],
            "boost_rejection_reason" => -1,
            "rating" => 1,
            "comments=>count" => 12,
            "impressions" => 5775,
            "reminds" => 131,
            "mature" => false,
            "wire_threshold" => null
        ]);

        $this->template->set('posts', $this->posts);

        $this->template->set('campaign', $this->campaign);
        $this->template->set('topic', $this->topic);

        $this->template->set('validator', $validatorHash);

        $subject = 'Trending posts';

        $message = new Message();
        $message->setTo($this->user)
            ->setMessageId(implode('-',
                [$this->user->guid, sha1($this->user->getEmail()), sha1($this->campaign . $this->topic . time())]))
            ->setSubject($subject)
            ->setHtml($this->template);

        print_r($message->buildHtml());
        die();

        //send email
        $this->mailer->queue($message);
    }

}
