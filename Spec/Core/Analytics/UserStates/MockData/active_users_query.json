{
    "index": "minds-metrics-*",
    "size": "0",
    "body": {
        "query": {
            "bool": {
                "must": [
                    {
                        "terms": {
                            "action.keyword": [ "active", "signup" ]
                        }
                    },
                    {
                        "range": {
                            "@timestamp": {
                                "from": 1548892800000,
                                "to": 1549584000000,
                                "format": "epoch_millis"
                            }
                        }
                    }
                ]
            }
        },
        "aggs": {
            "users": {
                "terms": {
                    "field": "user_guid.keyword",
                    "size": 5000,
                    "include": {
                        "partition": 0,
                        "num_partitions": 200
                    }
                },
                "aggs": {
                    "day-0-bucket": {
                        "date_range": {
                            "field": "@timestamp",
                            "ranges": [
                                {
                                    "from": 1549497600000,
                                    "to": 1549584000000
                                }
                            ]
                        }
                    },
                    "day-0": {
                        "sum_bucket": {
                            "buckets_path": "day-0-bucket>_count"
                        }
                    },
                    "day-1-bucket": {
                        "date_range": {
                            "field": "@timestamp",
                            "ranges": [
                                {
                                    "from": 1549411200000,
                                    "to": 1549497600000
                                }
                            ]
                        }
                    },
                    "day-1": {
                        "sum_bucket": {
                            "buckets_path": "day-1-bucket>_count"
                        }
                    },
                    "day-2-bucket": {
                        "date_range": {
                            "field": "@timestamp",
                            "ranges": [
                                {
                                    "from": 1549324800000,
                                    "to": 1549411200000
                                }
                            ]
                        }
                    },
                    "day-2": {
                        "sum_bucket": {
                            "buckets_path": "day-2-bucket>_count"
                        }
                    },
                    "day-3-bucket": {
                        "date_range": {
                            "field": "@timestamp",
                            "ranges": [
                                {
                                    "from": 1549238400000,
                                    "to": 1549324800000
                                }
                            ]
                        }
                    },
                    "day-3": {
                        "sum_bucket": {
                            "buckets_path": "day-3-bucket>_count"
                        }
                    },
                    "day-4-bucket": {
                        "date_range": {
                            "field": "@timestamp",
                            "ranges": [
                                {
                                    "from": 1549152000000,
                                    "to": 1549238400000
                                }
                            ]
                        }
                    },
                    "day-4": {
                        "sum_bucket": {
                            "buckets_path": "day-4-bucket>_count"
                        }
                    },
                    "day-5-bucket": {
                        "date_range": {
                            "field": "@timestamp",
                            "ranges": [
                                {
                                    "from": 1549065600000,
                                    "to": 1549152000000
                                }
                            ]
                        }
                    },
                    "day-5": {
                        "sum_bucket": {
                            "buckets_path": "day-5-bucket>_count"
                        }
                    },
                    "day-6-bucket": {
                        "date_range": {
                            "field": "@timestamp",
                            "ranges": [
                                {
                                    "from": 1548979200000,
                                    "to": 1549065600000
                                }
                            ]
                        }
                    },
                    "day-6": {
                        "sum_bucket": {
                            "buckets_path": "day-6-bucket>_count"
                        }
                    },
                    "day-7-bucket": {
                        "date_range": {
                            "field": "@timestamp",
                            "ranges": [
                                {
                                    "from": 1548892800000,
                                    "to": 1548979200000
                                }
                            ]
                        }
                    },
                    "day-7": {
                        "sum_bucket": {
                            "buckets_path": "day-7-bucket>_count"
                        }
                    }
                }
            }
        }
    }
}


{
    "_source": [
      "guid",
      "owner_guid",
      "@timestamp",
      "time_created",
      "access_id",
      "moderator_guid"
    ],
    "query": {
      "function_score": {
        "query": {
          "bool": {
            "must_not": [
              {
                "term": {
                  "deleted": true
                }
              },
              {
                "terms": {
                  "nsfw": [
                    1,
                    2,
                    3,
                    4,
                    5,
                    6
                  ]
                }
              },
              {
                "term": {
                  "mature": true
                }
              }
            ],
            "must": [
              {
                "terms": {
                  "access_id": [
                    "2"
                  ]
                }
              },
              {
                "range": {
                  "@timestamp": {
                    "lte": 1576624259000,
                    "gt": 1576581059000
                  }
                }
              },
              {
                "exists": {
                  "field": "votes:up"
                }
              }
            ]
          }
        },
        "score_mode": "sum",
        "functions": [
          {
            "filter": {
              "match_all": {}
            },
            "weight": 1
          },
          {
            "script_score": {
              "script": {
                "source": "\n            def up = (doc['votes:up'].value ?: 0) * 1.0;\n            def down = (doc['votes:down'].value ?: 0) * 1.0;\n            def magnitude = up + down;\n            \n            if (magnitude <= 0) {\n                return -10;\n            }\n            \n            def score = ((up + 1.9208) / (up + down) - 1.96 * Math.sqrt((up * down) / (up + down) + 0.9604) / (up + down)) / (1 + 3.8416 / (up + down));\n            \n            return score;\n        "
              }
            }
          }
        ]
      }
    },
    "sort": [
      {
        "_score": {
          "order": "desc"
        }
      }
    ]
  }